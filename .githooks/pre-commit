#!/usr/bin/env bash
###############################################################################
# Pre-commit hook — checks Terraform and Terragrunt file formatting.
# Fails the commit if any .tf or .hcl files are not properly formatted.
###############################################################################

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'
ERRORS=0

HAS_TERRAFORM=false
HAS_TERRAGRUNT=false
command -v terraform  > /dev/null 2>&1 && HAS_TERRAFORM=true
command -v terragrunt > /dev/null 2>&1 && HAS_TERRAGRUNT=true

# ── Terraform fmt check ─────────────────────────────────────────────────────

# Get staged .tf files
TF_FILES=$(git diff --cached --name-only --diff-filter=ACM -- '*.tf' || true)

if [[ -n "$TF_FILES" ]]; then
  if $HAS_TERRAFORM; then
    echo "Checking Terraform formatting..."
    if ! terraform fmt -check -recursive infrastructure/terraform/ > /dev/null 2>&1; then
      echo -e "${RED}✗ Terraform files are not formatted.${NC}"
      echo "  Run: terraform fmt -recursive infrastructure/terraform/"
      ERRORS=1
    else
      echo -e "${GREEN}✓ Terraform files formatted correctly${NC}"
    fi
  else
    echo -e "${YELLOW}⚠ terraform not installed — skipping .tf format check${NC}"
  fi
fi

# ── Terragrunt hclfmt check ─────────────────────────────────────────────────

# Get staged .hcl files
HCL_FILES=$(git diff --cached --name-only --diff-filter=ACM -- '*.hcl' || true)

if [[ -n "$HCL_FILES" ]]; then
  if $HAS_TERRAGRUNT; then
    echo "Checking Terragrunt formatting..."
    if ! terragrunt hclfmt --terragrunt-check --terragrunt-working-dir infrastructure/terragrunt > /dev/null 2>&1; then
      echo -e "${RED}✗ Terragrunt HCL files are not formatted.${NC}"
      echo "  Run: terragrunt hclfmt --terragrunt-working-dir infrastructure/terragrunt"
      ERRORS=1
    else
      echo -e "${GREEN}✓ Terragrunt HCL files formatted correctly${NC}"
    fi
  else
    echo -e "${YELLOW}⚠ terragrunt not installed — skipping .hcl format check${NC}"
  fi
fi

# ── Result ───────────────────────────────────────────────────────────────────

if [[ $ERRORS -ne 0 ]]; then
  echo ""
  echo -e "${RED}Commit blocked — fix formatting issues above, then retry.${NC}"
  exit 1
fi
